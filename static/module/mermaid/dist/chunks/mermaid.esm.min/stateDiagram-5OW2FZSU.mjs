import{a as O,c as N,d as X}from"./chunk-CA3VNNKQ.mjs";import{a as F}from"./chunk-BPGWHZJY.mjs";import{a as U}from"./chunk-P33YXMZK.mjs";import"./chunk-ZWOIQVFE.mjs";import"./chunk-7EQ4C65P.mjs";import"./chunk-QJ2DM6DA.mjs";import"./chunk-XDIKPSZQ.mjs";import"./chunk-WIFZSJ5L.mjs";import"./chunk-RNGNCJLM.mjs";import"./chunk-RD6ZT3JZ.mjs";import{m as C}from"./chunk-KIEMEOLO.mjs";import"./chunk-XE64DKBQ.mjs";import{Da as R,Ha as W,L as z,M as P,X as t,b,ga as L}from"./chunk-LXRGKPZR.mjs";import"./chunk-TI3GW6ZA.mjs";import"./chunk-LVHBRLQJ.mjs";import"./chunk-YLAFDWD2.mjs";import{a as f}from"./chunk-CPXVQKWD.mjs";var _=f(i=>i.append("circle").attr("class","start-state").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit).attr("cy",t().state.padding+t().state.sizeUnit),"drawStartState"),j=f(i=>i.append("line").style("stroke","grey").style("stroke-dasharray","3").attr("x1",t().state.textHeight).attr("class","divider").attr("x2",t().state.textHeight*2).attr("y1",0).attr("y2",0),"drawDivider"),q=f((i,n)=>{let s=i.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+2*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(n.id),c=s.node().getBBox();return i.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",c.width+2*t().state.padding).attr("height",c.height+2*t().state.padding).attr("rx",t().state.radius),s},"drawSimpleState"),Z=f((i,n)=>{let s=f(function(l,y,w){let k=l.append("tspan").attr("x",2*t().state.padding).text(y);w||k.attr("dy",t().state.textHeight)},"addTspan"),r=i.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+1.3*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(n.descriptions[0]).node().getBBox(),g=r.height,x=i.append("text").attr("x",t().state.padding).attr("y",g+t().state.padding*.4+t().state.dividerMargin+t().state.textHeight).attr("class","state-description"),e=!0,o=!0;n.descriptions.forEach(function(l){e||(s(x,l,o),o=!1),e=!1});let m=i.append("line").attr("x1",t().state.padding).attr("y1",t().state.padding+g+t().state.dividerMargin/2).attr("y2",t().state.padding+g+t().state.dividerMargin/2).attr("class","descr-divider"),h=x.node().getBBox(),d=Math.max(h.width,r.width);return m.attr("x2",d+3*t().state.padding),i.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",d+2*t().state.padding).attr("height",h.height+g+2*t().state.padding).attr("rx",t().state.radius),i},"drawDescrState"),Y=f((i,n,s)=>{let c=t().state.padding,r=2*t().state.padding,g=i.node().getBBox(),x=g.width,e=g.x,o=i.append("text").attr("x",0).attr("y",t().state.titleShift).attr("font-size",t().state.fontSize).attr("class","state-title").text(n.id),h=o.node().getBBox().width+r,d=Math.max(h,x);d===x&&(d=d+r);let l,y=i.node().getBBox();n.doc,l=e-c,h>x&&(l=(x-d)/2+c),Math.abs(e-y.x)<c&&h>x&&(l=e-(h-x)/2);let w=1-t().state.textHeight;return i.insert("rect",":first-child").attr("x",l).attr("y",w).attr("class",s?"alt-composit":"composit").attr("width",d).attr("height",y.height+t().state.textHeight+t().state.titleShift+1).attr("rx","0"),o.attr("x",l+c),h<=x&&o.attr("x",e+(d-r)/2-h/2+c),i.insert("rect",":first-child").attr("x",l).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",d).attr("height",t().state.textHeight*3).attr("rx",t().state.radius),i.insert("rect",":first-child").attr("x",l).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",d).attr("height",y.height+3+2*t().state.textHeight).attr("rx",t().state.radius),i},"addTitleAndBox"),K=f(i=>(i.append("circle").attr("class","end-state-outer").attr("r",t().state.sizeUnit+t().state.miniPadding).attr("cx",t().state.padding+t().state.sizeUnit+t().state.miniPadding).attr("cy",t().state.padding+t().state.sizeUnit+t().state.miniPadding),i.append("circle").attr("class","end-state-inner").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit+2).attr("cy",t().state.padding+t().state.sizeUnit+2)),"drawEndState"),Q=f((i,n)=>{let s=t().state.forkWidth,c=t().state.forkHeight;if(n.parentId){let r=s;s=c,c=r}return i.append("rect").style("stroke","black").style("fill","black").attr("width",s).attr("height",c).attr("x",t().state.padding).attr("y",t().state.padding)},"drawForkJoinState");var V=f((i,n,s,c)=>{let r=0,g=c.append("text");g.style("text-anchor","start"),g.attr("class","noteText");let x=i.replace(/\r\n/g,"<br/>");x=x.replace(/\n/g,"<br/>");let e=x.split(z.lineBreakRegex),o=1.25*t().state.noteMargin;for(let m of e){let h=m.trim();if(h.length>0){let d=g.append("tspan");if(d.text(h),o===0){let l=d.node().getBBox();o+=l.height}r+=o,d.attr("x",n+t().state.noteMargin),d.attr("y",s+r+1.25*t().state.noteMargin)}}return{textWidth:g.node().getBBox().width,textHeight:r}},"_drawLongText"),D=f((i,n)=>{n.attr("class","state-note");let s=n.append("rect").attr("x",0).attr("y",t().state.padding),c=n.append("g"),{textWidth:r,textHeight:g}=V(i,0,0,c);return s.attr("height",g+2*t().state.noteMargin),s.attr("width",r+t().state.noteMargin*2),s},"drawNote"),A=f(function(i,n){let s=n.id,c={id:s,label:n.id,width:0,height:0},r=i.append("g").attr("id",s).attr("class","stateGroup");n.type==="start"&&_(r),n.type==="end"&&K(r),(n.type==="fork"||n.type==="join")&&Q(r,n),n.type==="note"&&D(n.note.text,r),n.type==="divider"&&j(r),n.type==="default"&&n.descriptions.length===0&&q(r,n),n.type==="default"&&n.descriptions.length>0&&Z(r,n);let g=r.node().getBBox();return c.width=g.width+2*t().state.padding,c.height=g.height+2*t().state.padding,c},"drawState"),J=0,v=f(function(i,n,s){let c=f(function(o){switch(o){case N.relationType.AGGREGATION:return"aggregation";case N.relationType.EXTENSION:return"extension";case N.relationType.COMPOSITION:return"composition";case N.relationType.DEPENDENCY:return"dependency"}},"getRelationType");n.points=n.points.filter(o=>!Number.isNaN(o.y));let r=n.points,g=R().x(function(o){return o.x}).y(function(o){return o.y}).curve(W),x=i.append("path").attr("d",g(r)).attr("id","edge"+J).attr("class","transition"),e="";if(t().state.arrowMarkerAbsolute&&(e=window.location.protocol+"//"+window.location.host+window.location.pathname+window.location.search,e=e.replace(/\(/g,"\\("),e=e.replace(/\)/g,"\\)")),x.attr("marker-end","url("+e+"#"+c(N.relationType.DEPENDENCY)+"End)"),s.title!==void 0){let o=i.append("g").attr("class","stateLabel"),{x:m,y:h}=C.calcLabelPosition(n.points),d=z.getRows(s.title),l=0,y=[],w=0,k=0;for(let a=0;a<=d.length;a++){let u=o.append("text").attr("text-anchor","middle").text(d[a]).attr("x",m).attr("y",h+l),p=u.node().getBBox();w=Math.max(w,p.width),k=Math.min(k,p.x),b.info(p.x,m,h+l),l===0&&(l=u.node().getBBox().height,b.info("Title height",l,h)),y.push(u)}let M=l*d.length;if(d.length>1){let a=(d.length-1)*l*.5;y.forEach((u,p)=>u.attr("y",h+p*l-a)),M=l*d.length}let H=o.node().getBBox();o.insert("rect",":first-child").attr("class","box").attr("x",m-w/2-t().state.padding/2).attr("y",h-M/2-t().state.padding/2-3.5).attr("width",w+t().state.padding).attr("height",M+t().state.padding),b.info(H)}J++},"drawEdge");var S,G={},tt=f(function(){},"setConf"),et=f(function(i){i.append("defs").append("marker").attr("id","dependencyEnd").attr("refX",19).attr("refY",7).attr("markerWidth",20).attr("markerHeight",28).attr("orient","auto").append("path").attr("d","M 19,7 L9,13 L14,7 L9,1 Z")},"insertMarkers"),it=f(function(i,n,s,c){S=t().state;let r=t().securityLevel,g;r==="sandbox"&&(g=L("#i"+n));let x=r==="sandbox"?L(g.nodes()[0].contentDocument.body):L("body"),e=r==="sandbox"?g.nodes()[0].contentDocument:document;b.debug("Rendering diagram "+i);let o=x.select(`[id='${n}']`);et(o);let m=c.db.getRootDoc();I(m,o,void 0,!1,x,e,c);let h=S.padding,d=o.node().getBBox(),l=d.width+h*2,y=d.height+h*2,w=l*1.75;P(o,y,w,S.useMaxWidth),o.attr("viewBox",`${d.x-S.padding}  ${d.y-S.padding} `+l+" "+y)},"draw"),nt=f(i=>i?i.length*S.fontSizeFactor:1,"getLabelWidth"),I=f((i,n,s,c,r,g,x)=>{let e=new U({compound:!0,multigraph:!0}),o,m=!0;for(o=0;o<i.length;o++)if(i[o].stmt==="relation"){m=!1;break}s?e.setGraph({rankdir:"LR",multigraph:!0,compound:!0,ranker:"tight-tree",ranksep:m?1:S.edgeLengthFactor,nodeSep:m?1:50,isMultiGraph:!0}):e.setGraph({rankdir:"TB",multigraph:!0,compound:!0,ranksep:m?1:S.edgeLengthFactor,nodeSep:m?1:50,ranker:"tight-tree",isMultiGraph:!0}),e.setDefaultEdgeLabel(function(){return{}});let h=x.db.getStates(),d=x.db.getRelations(),l=Object.keys(h),y=!0;for(let a of l){let u=h[a];s&&(u.parentId=s);let p;if(u.doc){let B=n.append("g").attr("id",u.id).attr("class","stateGroup");if(p=I(u.doc,B,u.id,!c,r,g,x),y){B=Y(B,u,c);let E=B.node().getBBox();p.width=E.width,p.height=E.height+S.padding/2,G[u.id]={y:S.compositTitleSize}}else{let E=B.node().getBBox();p.width=E.width,p.height=E.height}}else p=A(n,u,e);if(u.note){let B={descriptions:[],id:u.id+"-note",note:u.note,type:"note"},E=A(n,B,e);u.note.position==="left of"?(e.setNode(p.id+"-note",E),e.setNode(p.id,p)):(e.setNode(p.id,p),e.setNode(p.id+"-note",E)),e.setParent(p.id,p.id+"-group"),e.setParent(p.id+"-note",p.id+"-group")}else e.setNode(p.id,p)}b.debug("Count=",e.nodeCount(),e);let w=0;d.forEach(function(a){w++,b.debug("Setting edge",a),e.setEdge(a.id1,a.id2,{relation:a,width:nt(a.title),height:S.labelHeight*z.getRows(a.title).length,labelpos:"c"},"id"+w)}),F(e),b.debug("Graph after layout",e.nodes());let k=n.node();e.nodes().forEach(function(a){a!==void 0&&e.node(a)!==void 0?(b.warn("Node "+a+": "+JSON.stringify(e.node(a))),r.select("#"+k.id+" #"+a).attr("transform","translate("+(e.node(a).x-e.node(a).width/2)+","+(e.node(a).y+(G[a]?G[a].y:0)-e.node(a).height/2)+" )"),r.select("#"+k.id+" #"+a).attr("data-x-shift",e.node(a).x-e.node(a).width/2),g.querySelectorAll("#"+k.id+" #"+a+" .divider").forEach(p=>{let B=p.parentElement,E=0,T=0;B&&(B.parentElement&&(E=B.parentElement.getBBox().width),T=parseInt(B.getAttribute("data-x-shift"),10),Number.isNaN(T)&&(T=0)),p.setAttribute("x1",0-T+8),p.setAttribute("x2",E-T-8)})):b.debug("No Node "+a+": "+JSON.stringify(e.node(a)))});let M=k.getBBox();e.edges().forEach(function(a){a!==void 0&&e.edge(a)!==void 0&&(b.debug("Edge "+a.v+" -> "+a.w+": "+JSON.stringify(e.edge(a))),v(n,e.edge(a),e.edge(a).relation))}),M=k.getBBox();let H={id:s||"root",label:s||"root",width:0,height:0};return H.width=M.width+2*S.padding,H.height=M.height+2*S.padding,b.debug("Doc rendered",H,e),H},"renderDoc"),$={setConf:tt,draw:it};var Mt={parser:O,get db(){return new N(1)},renderer:$,styles:X,init:f(i=>{i.state||(i.state={}),i.state.arrowMarkerAbsolute=i.arrowMarkerAbsolute},"init")};export{Mt as diagram};
